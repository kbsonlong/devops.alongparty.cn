[{"categories":["云原生"],"content":"1限流 ","date":"2022-05-23","objectID":"/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/:0:0","tags":["istio"],"title":"Istio防故障利器","uri":"/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/"},{"categories":["云原生"],"content":"1.1什么是限流 ​ 举个例子，比如我们有个桶，桶里有两个开关，一个往外出水，一个网内注水，当出水的速度慢于注水的速度时，到一定时间水就会从桶里溢出。如果我们限制注水速率，就可以防止水从桶里溢出，这就是限流。 ​ 具体到软件层面，我们把请求速率看做是注水，把系统cpu，内存等资源看做是放水，当请求速率过快，消耗太多资源时系统就可能崩溃。软件限流就是限制tps或qps指标，以达到保护系统的目的，虽然可能部分用户无法服务，但是系统整体还是健康的，还可以对外部提供服务，不是整体挂掉。 ","date":"2022-05-23","objectID":"/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/:1:0","tags":["istio"],"title":"Istio防故障利器","uri":"/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/"},{"categories":["云原生"],"content":"1.2限流算法 1.2.1漏桶算法 就像一个漏斗以下，下面小，上面大。漏桶流出的速率被限制在比较小的范围，当漏桶满时，漏桶就会溢出，进来的请求就会被抛弃掉。特别是应对突发流量，漏桶的速率是恒定的，这样可以有效防止应突发流量导致系统崩溃。 ","date":"2022-05-23","objectID":"/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/:2:0","tags":["istio"],"title":"Istio防故障利器","uri":"/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/"},{"categories":["云原生"],"content":"1.2.2令牌桶算法 令牌桶算法的原理，关键在令牌，它是指往桶里以一个不变的速率放入令牌，当有请求时，如果桶里有令牌，请求就消费一个令牌，请求继续进行；当请求到来，桶里没有令牌时，请求就会被抛弃掉，拒绝服务；当桶里的令牌满时，令牌就会被抛弃掉。 ","date":"2022-05-23","objectID":"/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/:2:1","tags":["istio"],"title":"Istio防故障利器","uri":"/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/"},{"categories":["云原生"],"content":"1.2.3计数器算法 计数器算法是指一段时间设置一个计数器，当有请求时计数器就加一，请求继续进行；在技术器时间范围内，当计数器数值超过指定值，请求就被拒绝；当时间范围结束，就重置计数器。技术器算法有个缺陷，就是如果计数器时间是1分钟，当前1秒来了大量请求，讲技术器用完了，后续59秒时间就没法提供服务。 ","date":"2022-05-23","objectID":"/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/:2:2","tags":["istio"],"title":"Istio防故障利器","uri":"/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/"},{"categories":["云原生"],"content":"1.2实操 ","date":"2022-05-23","objectID":"/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/:3:0","tags":["istio"],"title":"Istio防故障利器","uri":"/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/"},{"categories":["云原生"],"content":"1.2.1 http 1.2.1.1单集群 istio部署和bookinfo实例部署大家自行完成，都看这种深度的文章了这个应该不是事。 1.2.1.1.1集群内服务限流 1.2.1.1.1.1本地限流 cat \u003c\u003cEOF \u003e envoyfilter-local-rate-limit.yamlapiVersion:networking.istio.io/v1alpha3kind:EnvoyFiltermetadata:name:filter-local-ratelimit-svcspec:workloadSelector:labels:app:productpageconfigPatches:- applyTo:HTTP_FILTERmatch:listener:filterChain:filter:name:\"envoy.filters.network.http_connection_manager\"patch:operation:INSERT_BEFOREvalue:name:envoy.filters.http.local_ratelimittyped_config:\"@type\": type.googleapis.com/udpa.type.v1.TypedStructtype_url:type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimitvalue:stat_prefix:http_local_rate_limitertoken_bucket:max_tokens:10tokens_per_fill:10fill_interval:60sfilter_enabled:runtime_key:local_rate_limit_enableddefault_value:numerator:100denominator:HUNDREDfilter_enforced:runtime_key:local_rate_limit_enforceddefault_value:numerator:100denominator:HUNDREDresponse_headers_to_add:- append:falseheader:key:x-local-rate-limitvalue:'true'EOF kubectl apply -f envoyfilter-local-rate-limit.yaml -n istio 说明：本地限流需要通过EnvoyFilter来实现，他不会请求外部服务，在envoy内部实现支持，是一个令牌桶的算法。http filter的名称必须是envoy.filters.http.local_ratelimit，type和typeurl是固定的，stat_prefix可以随便改，表示生成stat的指标前缀。token_bucket配置令牌桶，max_tokens表示最大令牌数量，tokens_per_fill表示每次填充的令牌数量，fill_interval表示填充令牌的间隔。filter_enabled表示启用但不是强制，filter_enforced表示强制，可以配置百分比。response_headers_to_add修改响应头信息，append为false表示修改，true表示添加。runtime_key 运行时的key，具体有啥用不清楚。 执行压测： [root@node01 45]# go-stress-testing -c 10 -n 10000 -u http://192.168.229.134:30945/productpage 开始启动 并发数:10 请求数:10000 请求参数: request: form:http url:http://192.168.229.134:30945/productpage method:GET headers:map[] data: verify:statusCode timeout:30s debug:false ─────┬───────┬───────┬───────┬────────┬────────┬────────┬────────┬────────┬────────┬──────── 耗时│ 并发数│ 成功数│ 失败数│ qps │最长耗时│最短耗时│平均耗时│下载字节│字节每秒│ 错误码 ─────┼───────┼───────┼───────┼────────┼────────┼────────┼────────┼────────┼────────┼──────── 1s│ 7│ 2│ 761│ 2.94│ 124.68│ 1.98│ 3406.97│ 21,476│ 21,470│200:2;429:761 2s│ 10│ 5│ 1636│ 2.55│ 1788.46│ 1.98│ 3928.11│ 52,771│ 26,383│200:5;429:1636 3s│ 10│ 5│ 2962│ 1.70│ 1788.46│ 1.04│ 5871.68│ 76,639│ 25,545│200:5;429:2962 4s│ 10│ 5│ 4459│ 1.28│ 1788.46│ 1.04│ 7810.78│ 103,585│ 25,896│200:5;429:4459 429 Too Many Requests (太多请求) 当你需要限制客户端请求某个服务的数量，也就是限制请求速度时，该状态码就会非常有用 清理： kubectl delete envoyfilter filter-local-ratelimit-svc -n istio 1.2.1.1.1.2全局限流 部署ratelimit 1创建cm cat \u003c\u003c EOF \u003e ratelimit-config.yamlapiVersion:v1kind:ConfigMapmetadata:name:ratelimit-configdata:config.yaml:|domain: productpage-ratelimit descriptors: - key: PATH value: \"/productpage\" rate_limit: unit: minute requests_per_unit: 1 - key: PATH rate_limit: unit: minute requests_per_unit: 100EOFkubectl apply -f ratelimit-config.yaml -n istio 说明: 这个configmap是限速服务用到的配置文件，他是envoy v3版本的限速格式。domain是域名，他会在envoyfilter中被引用，descriptors的PATH,表示请求的路径可以有多个值，rate_limit配置限速配额，这里productpage配了1分钟1个请求，其他url是1分钟100个请求 2创建限速服务deployment cat \u003c\u003c EOF \u003e ratelimit-deploy.yamlapiVersion:v1kind:Servicemetadata:name:redislabels:app:redisspec:ports:- name:redisport:6379selector:app:redis---apiVersion:apps/v1kind:Deploymentmetadata:name:redisspec:replicas:1selector:matchLabels:app:redistemplate:metadata:labels:app:redisspec:containers:- image:redis:alpineimagePullPolicy:Alwaysname:redisports:- name:rediscontainerPort:6379restartPolicy:AlwaysserviceAccountName:\"\"---apiVersion:v1kind:Servicemetadata:name:ratelimitlabels:app:ratelimitspec:ports:- name:http-portport:8080targetPort:8080protocol:TCP- name:grpc-portport:8081targetPort:8081protocol:TCP- name:http-debugport:6070targetPort:6070protocol:TCPselector:app:ratelimit---apiVersion:apps/v1kind:Deploymentmetadata:name:ratelimitspec:replicas:1selector:matchLabels:app:ratelimitstrategy:type:Recreatetemplate:metadata:labels:app:ratelimitspec:containers:- image:envoyproxy/ratelimit:6f5de117# 2021/01/08imagePullPolicy:Alwaysname:ratelimitcommand:[\"/bin/ratelimit\"]env:- name:LOG_LEVELvalue:debug- name:REDIS_SOCKET_TY","date":"2022-05-23","objectID":"/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/:3:1","tags":["istio"],"title":"Istio防故障利器","uri":"/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/"},{"categories":null,"content":"kbsonlong's friends","date":"2022-05-23","objectID":"/friends/","tags":null,"title":"Index","uri":"/friends/"},{"categories":null,"content":"Base info - nickname:蜷缩的蜗牛avatar:images/20220524130401.pngurl:https://www.alongparty.cndescription:运维自动化 ","date":"2022-05-23","objectID":"/friends/:1:0","tags":null,"title":"Index","uri":"/friends/"},{"categories":null,"content":"Friendly Reminder Notice If you want to exchange link, please leave a comment in the above format. (personal non-commercial blogs / websites only)  Website failure, stop maintenance and improper content may be unlinked! Those websites that do not respect other people’s labor achievements, reprint without source, or malicious acts, please do not come to exchange. ","date":"2022-05-23","objectID":"/friends/:2:0","tags":null,"title":"Index","uri":"/friends/"},{"categories":["云原生"],"content":"压测大纲 压测的必要性 压测部署架构图 环境准备 ","date":"2022-05-23","objectID":"/istio%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/:0:0","tags":["istio"],"title":"Istio性能测试","uri":"/istio%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/"},{"categories":["云原生"],"content":"部署 Istio ","date":"2022-05-23","objectID":"/istio%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/:1:0","tags":["istio"],"title":"Istio性能测试","uri":"/istio%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/"},{"categories":["云原生"],"content":"部署监控组件 ","date":"2022-05-23","objectID":"/istio%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/:2:0","tags":["istio"],"title":"Istio性能测试","uri":"/istio%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/"},{"categories":["云原生"],"content":"部署压测服务 ","date":"2022-05-23","objectID":"/istio%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/:3:0","tags":["istio"],"title":"Istio性能测试","uri":"/istio%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/"},{"categories":["云原生"],"content":"部署压测工具 性能压测 压测报告","date":"2022-05-23","objectID":"/istio%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/:4:0","tags":["istio"],"title":"Istio性能测试","uri":"/istio%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/"},{"categories":["hugo"],"content":"创建Github Actions流水线 mkdir -p .github/workflows/ touch hugo.yaml 发布到本仓库 name:GitHub Pages Deploy Local REPOSITORYon:push:branches:- master # Set a branch to deploypull_request:jobs:deploy:runs-on:ubuntu-20.04concurrency:group:${{ github.workflow }}-${{ github.ref }}steps:- uses:actions/checkout@v3with:submodules:true# Fetch Hugo themes (true OR recursive)fetch-depth:1# Fetch all history for .GitInfo and .Lastmod- name:Setup Hugouses:peaceiris/actions-hugo@v2with:hugo-version:'0.91.2'extended:true- name:Buildrun:hugo --minify- name:Deployuses:peaceiris/actions-gh-pages@v3with:github_token:${{ secrets.GITHUB_TOKEN }}publish_dir:./public 发布到另外仓库 name:CI#自动化的名称on:push:# push的时候触发branches:# 那些分支需要触发- masterjobs:deploy:runs-on:ubuntu-20.04steps:- uses:actions/checkout@v2with:submodules:true# Fetch Hugo themes (true OR recursive)fetch-depth:1# Fetch all history for .GitInfo and .Lastmod- name:Setup Hugouses:peaceiris/actions-hugo@v2with:hugo-version:'latest'extended:true- name:Buildrun:hugo --minify- name:Deployuses:peaceiris/actions-gh-pages@v3with:personal_token:${{ secrets.EXTERNAL_REPOSITORY_TOKEN }}publish_dir:./publicexternal_repository:kbsonlong/devops.alongparty.cn 注意: 发布到本仓库github_token不需要手动创建GITHUB_TOKEN, 发布到其他仓库personal_token需要提前创建并配置secret变量 创建SSH证书 ssh-keygen -t rsa -b 4096 -C \"$(git config user.email)\" -f gh-pages -N \"\" 配置SSH公钥 配置SSH私钥 使用SSH私钥发布 name:CI#自动化的名称on:push:# push的时候触发branches:# 那些分支需要触发- masterjobs:deploy:runs-on:ubuntu-20.04steps:- uses:actions/checkout@v2with:submodules:true# Fetch Hugo themes (true OR recursive)fetch-depth:1# Fetch all history for .GitInfo and .Lastmod- name:Setup Hugouses:peaceiris/actions-hugo@v2with:hugo-version:'latest'extended:true- name:Buildrun:hugo --minify- name:Deploy with PRIVATE KEYuses:peaceiris/actions-gh-pages@v3with:cname:devops.alongparty.cnenv:ACTIONS_DEPLOY_KEY:${{ secrets.HUGO_DEPLOY_PRIVATE_KEY }}EXTERNAL_REPOSITORY:kbsonlong/devops.alongparty.cnPUBLISH_BRANCH:gh-pagesPUBLISH_DIR:./public 注意: 部署到另外仓库时ssh私钥配置在源仓库, ssh公钥配置在目标仓库或者全局 ","date":"2022-05-23","objectID":"/github-actions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2hugo%E5%8D%9A%E5%AE%A2/:0:1","tags":["github actions"],"title":"Github Actions自动部署hugo博客","uri":"/github-actions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2hugo%E5%8D%9A%E5%AE%A2/"},{"categories":["hugo"],"content":"创建GITHUB Personal TOKEN ","date":"2022-05-23","objectID":"/github-actions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2hugo%E5%8D%9A%E5%AE%A2/:0:2","tags":["github actions"],"title":"Github Actions自动部署hugo博客","uri":"/github-actions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2hugo%E5%8D%9A%E5%AE%A2/"},{"categories":["hugo"],"content":"创建仓库Secrets变量 ","date":"2022-05-23","objectID":"/github-actions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2hugo%E5%8D%9A%E5%AE%A2/:0:3","tags":["github actions"],"title":"Github Actions自动部署hugo博客","uri":"/github-actions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2hugo%E5%8D%9A%E5%AE%A2/"},{"categories":["hugo"],"content":"Github Page配置自定义域名 echo \"\u003c自定义域名\u003e\" \u003estatic/CNAME ","date":"2022-05-23","objectID":"/github-actions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2hugo%E5%8D%9A%E5%AE%A2/:0:4","tags":["github actions"],"title":"Github Actions自动部署hugo博客","uri":"/github-actions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2hugo%E5%8D%9A%E5%AE%A2/"}]